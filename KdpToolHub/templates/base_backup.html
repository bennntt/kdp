<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}KDP Tools - Your Publishing Success Partner{% endblock %}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="{% block description %}Professional KDP tools for Amazon publishers. Generate titles, descriptions, research keywords, and calculate royalties with our comprehensive publishing toolkit.{% endblock %}">
    <meta name="keywords" content="KDP tools, Amazon publishing, book marketing, title generator, keyword research, royalty calculator">
    <meta name="author" content="KDP Tools">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}KDP Tools - Your Publishing Success Partner{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Professional KDP tools for Amazon publishers. Generate titles, descriptions, research keywords, and calculate royalties.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Navigation - Show only on non-tools pages -->
    {% if not (current_user.is_authenticated and request.endpoint and request.endpoint.startswith('tools.')) %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-book-open me-2"></i>KDP Tools
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Navigation Links in Center -->
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                    </li>
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('tools.dashboard') }}">Dashboard</a>
                        </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('plans') }}">Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('contact') }}">Contact</a>
                    </li>
                </ul>
                
                <!-- Auth Links -->
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>{{ current_user.username }}
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="openSettingsModal()">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('google_auth.logout') }}">
                                    <i class="fas fa-sign-out-alt me-2"></i>Log out
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.login') }}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.register') }}">Register</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Flash Messages for non-dashboard pages -->
    {% if not (current_user.is_authenticated and request.endpoint and request.endpoint.startswith('tools.')) %}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container-fluid position-fixed" style="top: 70px; z-index: 1040;">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show auto-dismiss-alert" role="alert" data-auto-dismiss="true">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    {% endif %}

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-layout">
            {% if current_user.is_authenticated and request.endpoint and request.endpoint.startswith('tools.') %}
                <!-- Tool pages layout with sidebar -->
                <div class="container-fluid">
                    <div class="row">
                        <!-- Sidebar -->
                        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse d-flex flex-column">
                            <!-- Scrollable content area -->
                            <div class="sidebar-content flex-grow-1 overflow-auto sidebar-scroll-area">
                                <ul class="nav flex-column px-3">
                                    <li class="nav-item">
                                        <a class="nav-link {% if request.endpoint == 'tools.dashboard' %}active{% endif %}" href="{{ url_for('tools.dashboard') }}">
                                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                                        </a>
                                    </li>
                                    
                                    <hr class="my-2">
                                    <h6 class="sidebar-heading text-muted mt-4 mb-1">Generation Tools</h6>
                                    
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.title_generator' %}active{% endif %}" href="{{ url_for('tools.title_generator') }}">
                                                <i class="fas fa-heading me-2"></i>Title Generator
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-heading me-2"></i>Title Generator
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.subtitle_generator' %}active{% endif %}" href="{{ url_for('tools.subtitle_generator') }}">
                                                <i class="fas fa-text-height me-2"></i>Subtitle Generator
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-text-height me-2"></i>Subtitle Generator
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.description_generator' %}active{% endif %}" href="{{ url_for('tools.description_generator') }}">
                                                <i class="fas fa-align-left me-2"></i>Description Generator
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-align-left me-2"></i>Description Generator
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.author_generator' %}active{% endif %}" href="{{ url_for('tools.author_generator') }}">
                                                <i class="fas fa-user-edit me-2"></i>Author Generator
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-user-edit me-2"></i>Author Generator
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    
                                    <hr class="my-2">
                                    <h6 class="sidebar-heading text-muted mt-4 mb-1">Research Tools</h6>
                                    
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.keyword_research' %}active{% endif %}" href="{{ url_for('tools.keyword_research') }}">
                                                <i class="fas fa-search me-2"></i>Keyword Research
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-search me-2"></i>Keyword Research
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.category_finder' %}active{% endif %}" href="{{ url_for('tools.category_finder') }}">
                                                <i class="fas fa-tags me-2"></i>Category Finder
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-tags me-2"></i>Category Finder
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.trademark_search' %}active{% endif %}" href="{{ url_for('tools.trademark_search') }}">
                                                <i class="fas fa-shield-alt me-2"></i>Trademark Search
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-shield-alt me-2"></i>Trademark Search
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                    
                                    <hr class="my-2">
                                    <h6 class="sidebar-heading text-muted mt-4 mb-1">Business Tools</h6>
                                    
                                    <li class="nav-item">
                                        {% if current_user.email_verified %}
                                            <a class="nav-link {% if request.endpoint == 'tools.royalty_calculator' %}active{% endif %}" href="{{ url_for('tools.royalty_calculator') }}">
                                                <i class="fas fa-calculator me-2"></i>Royalty Calculator
                                            </a>
                                        {% else %}
                                            <span class="nav-link disabled-tool" onclick="showVerificationNotice()">
                                                <i class="fas fa-calculator me-2"></i>Royalty Calculator
                                                <i class="fas fa-lock ms-auto"></i>
                                            </span>
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                        </nav>
                        
                        <!-- Fixed header section at top - outside nav -->
                        <div class="sidebar-header-fixed bg-dark border-bottom border-secondary p-3">
                            <a href="{{ url_for('index') }}" class="text-decoration-none">
                                <h4 class="text-white mb-0">
                                    <i class="fas fa-book-open me-2"></i>KDP Tools
                                </h4>
                            </a>
                        </div>
                        
                        <!-- Fixed user section at bottom - outside nav -->
                        {% if current_user.is_authenticated %}
                            <div class="sidebar-user-fixed bg-dark border-top p-3">
                                <div class="dropdown dropup">
                                    <a class="nav-link d-flex align-items-center text-light" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user-circle me-2"></i>
                                        <span>amine</span>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="openSettingsModal()">
                                            <i class="fas fa-cog me-2"></i>Settings
                                        </a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('google_auth.logout') }}">
                                            <i class="fas fa-sign-out-alt me-2"></i>Log out
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Main content area for tools -->
                        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-0">
                            {% block tool_content %}{% endblock %}
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Regular layout for non-tool pages -->
                <div class="regular-content-area">
                    {% block content %}{% endblock %}
                </div>
            {% endif %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-book-open me-2"></i>KDP Tools</h5>
                    <p class="text-muted">Your complete toolkit for Amazon KDP publishing success.</p>
                </div>
                <div class="col-md-3">
                    <h6>Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('plans') }}" class="text-muted text-decoration-none">Pricing Plans</a></li>
                        <li><a href="{{ url_for('contact') }}" class="text-muted text-decoration-none">Contact Support</a></li>
                        {% if current_user.is_authenticated %}
                            <li><a href="{{ url_for('tools.dashboard') }}" class="text-muted text-decoration-none">Dashboard</a></li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Tools</h6>
                    <ul class="list-unstyled">
                        <li><span class="text-muted">Title Generator</span></li>
                        <li><span class="text-muted">Keyword Research</span></li>
                        <li><span class="text-muted">Royalty Calculator</span></li>
                        <li><span class="text-muted">And more...</span></li>
                    </ul>
                </div>
            </div>
            <hr class="my-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="text-muted mb-0">&copy; 2024 KDP Tools. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">Made for Amazon KDP Publishers</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <script>
    function showVerificationNotice() {
        const toast = document.createElement('div');
        toast.className = 'toast-notification toast-warning';
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Please verify your email address to access tools.
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showFlashMessage(message, category) {
        const toast = document.createElement('div');
        const iconClass = category === 'success' ? 'check-circle' : 
                         category === 'warning' ? 'exclamation-triangle' : 
                         category === 'error' ? 'times-circle' : 'info-circle';
        const toastClass = category === 'error' ? 'toast-danger' : `toast-${category}`;
        
        toast.className = `toast-notification ${toastClass}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${iconClass} me-2"></i>
                ${message}
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    function showChangeEmailModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'changeEmailModal';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">Change Email Address</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('auth.change_email') }}" method="POST">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="currentEmail" class="form-label">Current Email</label>
                                <input type="email" class="form-control bg-secondary text-light border-secondary" 
                                       id="currentEmail" value="{{ current_user.email if current_user.is_authenticated else '' }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="newEmail" class="form-label">New Email Address</label>
                                <input type="email" class="form-control bg-secondary text-light border-secondary" 
                                       id="newEmail" name="new_email" required placeholder="Enter new email address">
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                You will need to verify your new email address before accessing tools.
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-1"></i>Update Email
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
    }

    // Auto-dismiss flash messages after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        // Show flash messages as toast notifications for dashboard pages
        {% if current_user.is_authenticated and request.endpoint and request.endpoint.startswith('tools.') %}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        showFlashMessage('{{ message|safe }}', '{{ category }}');
                    {% endfor %}
                {% endif %}
            {% endwith %}
        {% endif %}
        
        const autoDismissAlerts = document.querySelectorAll('.auto-dismiss-alert[data-auto-dismiss="true"]');
        
        autoDismissAlerts.forEach(function(alert) {
            // Auto dismiss after 5 seconds
            setTimeout(function() {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });
    });
    </script>
    
    <style>
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        font-weight: 500;
    }

    .toast-notification.toast-warning {
        background: #ffc107;
        color: #000;
    }

    .toast-notification.toast-success {
        background: #198754;
        color: #fff;
    }

    .toast-notification.toast-danger {
        background: #dc3545;
        color: #fff;
    }

    .toast-notification.toast-info {
        background: #0dcaf0;
        color: #000;
    }

    .toast-notification.show {
        transform: translateX(0);
    }

    .toast-content {
        display: flex;
        align-items: center;
    }
    
    /* Settings Modal Styles */
    .settings-nav .nav-link {
        border-radius: 10px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }
    
    .settings-nav .nav-link:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: rgba(102, 126, 234, 0.3);
        transform: translateX(5px);
    }
    
    .settings-nav .nav-link.active {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white !important;
    }
    
    .settings-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .settings-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(102, 126, 234, 0.3);
        transform: translateY(-2px);
    }
    
    .settings-input {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: #fff !important;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .settings-input:focus {
        background: rgba(0, 0, 0, 0.4) !important;
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
        color: #fff !important;
    }
    
    .settings-input option {
        background: #2d2d2d;
        color: #fff;
    }
    
    .settings-switch {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
    }
    
    .settings-switch:checked {
        background-color: #667eea !important;
        border-color: #667eea !important;
    }
    
    .settings-switch:focus {
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
    }
    
    .settings-section h6 {
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .modal-content .badge {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }
    
    .btn-outline-primary:hover, .btn-outline-info:hover, .btn-outline-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    </style>
    
    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: linear-gradient(145deg, #1a1a1a 0%, #2d2d2d 100%); border: none; border-radius: 0;">
                <div class="modal-header" style="border-bottom: 1px solid #404040; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title text-white fw-bold" id="settingsModalLabel">
                        <i class="fas fa-user-cog me-2"></i>Account Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 text-light">
                    <div class="row">
                        <div class="col-lg-2 col-md-3">
                            <div class="nav flex-column nav-pills settings-nav" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                <button class="nav-link active text-start mb-3 settings-nav-item" id="v-pills-account-tab" data-bs-toggle="pill" data-bs-target="#v-pills-account" type="button" role="tab">
                                    <i class="fas fa-user me-2"></i>Account Settings
                                </button>
                                <button class="nav-link text-start mb-3 settings-nav-item" id="v-pills-subscription-tab" data-bs-toggle="pill" data-bs-target="#v-pills-subscription" type="button" role="tab">
                                    <i class="fas fa-credit-card me-2"></i>Subscription
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-10 col-md-9">
                            <div class="tab-content" id="v-pills-tabContent">
                                <!-- Account Settings Tab -->
                                <div class="tab-pane fade show active" id="v-pills-general" role="tabpanel">
                                    <div class="settings-section">
                                        <h6 class="text-primary mb-3"><i class="fas fa-paint-brush me-2"></i>Interface Settings</h6>
                                        <div class="settings-card p-3 mb-3">
                                            <label for="theme" class="form-label fw-semibold">Theme</label>
                                            <select class="form-select settings-input" id="theme">
                                                <option value="dark" selected>Dark Theme</option>
                                                <option value="light">Light Theme</option>
                                                <option value="auto">Auto (System)</option>
                                            </select>
                                            <small class="text-muted">Choose your preferred color scheme</small>
                                        </div>
                                        
                                        <div class="settings-card p-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <label class="form-label fw-semibold mb-1">Compact Mode</label>
                                                    <div><small class="text-muted">Reduce spacing for more content</small></div>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input settings-switch" type="checkbox" id="compactMode">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="settings-card p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <label class="form-label fw-semibold mb-1">Animations</label>
                                                    <div><small class="text-muted">Enable smooth transitions</small></div>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input settings-switch" type="checkbox" id="animations" checked>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Account Tab -->
                                <div class="tab-pane fade" id="v-pills-account" role="tabpanel">
                                    <div class="settings-section">
                                        <h6 class="text-primary mb-3"><i class="fas fa-user-circle me-2"></i>Account Information</h6>
                                        <div class="settings-card p-3 mb-3">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="username" class="form-label fw-semibold">Username</label>
                                                    <input type="text" class="form-control settings-input" id="username" value="{{ current_user.username if current_user.is_authenticated else 'amine' }}" readonly>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="email" class="form-label fw-semibold">Email Address</label>
                                                    <input type="email" class="form-control settings-input" id="email" value="{{ current_user.email if current_user.is_authenticated else 'user@example.com' }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-2">Subscription Status</h6>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-success me-2">{{ current_user.subscription_type.title() if current_user.is_authenticated else 'Free' }} Plan</span>
                                                <small class="text-muted">Active since {{ current_user.created_at.strftime('%B %Y') if current_user.is_authenticated else 'January 2025' }}</small>
                                            </div>
                                        </div>

                                        <div class="settings-card p-3">
                                            <h6 class="fw-semibold mb-2">Quick Actions</h6>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-key me-1"></i>Change Password
                                                </button>
                                                <button class="btn btn-outline-info btn-sm">
                                                    <i class="fas fa-download me-1"></i>Export Data
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security Tab -->
                                <div class="tab-pane fade" id="v-pills-security" role="tabpanel">
                                    <div class="settings-section">
                                        <h6 class="text-primary mb-3"><i class="fas fa-key me-2"></i>Security & Access</h6>
                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-3">Change Password</h6>
                                            <p class="text-muted small mb-3">Update your current password securely</p>
                                            <button class="btn btn-outline-warning btn-sm">
                                                <i class="fas fa-key me-1"></i>Change Password
                                            </button>
                                        </div>
                                        
                                        <div class="settings-card p-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="fw-semibold mb-1">Two-Factor Authentication (2FA)</h6>
                                                    <small class="text-muted">Enable extra login security via email or authenticator app</small>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input settings-switch" type="checkbox" id="twoFactorAuth" {{ 'checked' if current_user.two_factor_enabled else '' }}>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-3">Active Sessions</h6>
                                            <p class="text-muted small mb-3">View all logged-in devices and revoke access</p>
                                            <div id="activeSessions" class="mb-3">
                                                <div class="text-center">
                                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                    Loading sessions...
                                                </div>
                                            </div>
                                            <button class="btn btn-outline-info btn-sm" onclick="loadActiveSessions()">
                                                <i class="fas fa-sync me-1"></i>Refresh Sessions
                                            </button>
                                        </div>

                                        <div class="settings-card p-3">
                                            <h6 class="fw-semibold mb-3">Login History</h6>
                                            <p class="text-muted small mb-3">See recent logins with timestamps and IPs</p>
                                            <div id="loginHistory" class="mb-3">
                                                <div class="text-center">
                                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                    Loading history...
                                                </div>
                                            </div>
                                            <button class="btn btn-outline-info btn-sm" onclick="loadLoginHistory()">
                                                <i class="fas fa-history me-1"></i>Refresh History
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Communication Tab -->
                                <div class="tab-pane fade" id="v-pills-communication" role="tabpanel">
                                    <div class="settings-section">
                                        <h6 class="text-primary mb-3"><i class="fas fa-at me-2"></i>Email & Notifications</h6>
                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-3">Change Email Address</h6>
                                            <p class="text-muted small mb-3">Update your account email with verification</p>
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">Current Email</label>
                                                <input type="email" class="form-control settings-input" value="{{ current_user.email if current_user.is_authenticated else 'user@example.com' }}" readonly>
                                            </div>
                                            <button class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-envelope me-1"></i>Change Email
                                            </button>
                                        </div>

                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-3">Notification Settings</h6>
                                            <p class="text-muted small mb-3">Choose which types of alerts/emails to receive</p>
                                            
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <label class="form-label fw-semibold mb-1">Email Notifications</label>
                                                    <div><small class="text-muted">Tool updates and important alerts</small></div>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input settings-switch" type="checkbox" id="emailNotifications" {{ 'checked' if current_user.email_notifications else '' }}>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <label class="form-label fw-semibold mb-1">Browser Notifications</label>
                                                    <div><small class="text-muted">Desktop notifications in browser</small></div>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input settings-switch" type="checkbox" id="browserNotifications" {{ 'checked' if current_user.browser_notifications else '' }}>
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <label class="form-label fw-semibold mb-1">Marketing Emails</label>
                                                    <div><small class="text-muted">Tips, announcements, and promotional content</small></div>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input settings-switch" type="checkbox" id="marketingEmails" {{ 'checked' if current_user.marketing_emails else '' }}>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Billing Tab -->
                                <div class="tab-pane fade" id="v-pills-billing" role="tabpanel">
                                    <div class="settings-section">
                                        <h6 class="text-primary mb-3"><i class="fas fa-credit-card me-2"></i>Billing & Subscription</h6>
                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-3">Current Plan</h6>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <span class="badge bg-{{ 'success' if current_user.subscription_type != 'free' else 'secondary' }} me-2">
                                                        {{ current_user.subscription_type.title() if current_user.is_authenticated else 'Free' }} Plan
                                                    </span>
                                                    <small class="text-muted">
                                                        {% if current_user.is_authenticated and current_user.subscription_end %}
                                                            Expires: {{ current_user.subscription_end.strftime('%B %d, %Y') }}
                                                        {% else %}
                                                            No expiration
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-arrow-up me-1"></i>Upgrade Plan
                                                </button>
                                            </div>
                                        </div>

                                        <div class="settings-card p-3 mb-3">
                                            <h6 class="fw-semibold mb-3">Billing History</h6>
                                            <p class="text-muted small mb-3">View and download previous invoices and receipts</p>
                                            <button class="btn btn-outline-info btn-sm">
                                                <i class="fas fa-file-invoice me-1"></i>View Billing History
                                            </button>
                                        </div>

                                        {% if current_user.is_authenticated and current_user.subscription_type != 'free' %}
                                        <div class="settings-card p-3">
                                            <h6 class="fw-semibold mb-3">Cancel Subscription</h6>
                                            <p class="text-muted small mb-3">Stop auto-renewal or deactivate premium access</p>
                                            <button class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-times me-1"></i>Cancel Subscription
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Danger Zone Tab -->
                                <div class="tab-pane fade" id="v-pills-danger" role="tabpanel">
                                    <div class="settings-section">
                                        <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h6>
                                        <div class="settings-card border-danger p-3">
                                            <h6 class="fw-semibold text-danger mb-3">Delete Account</h6>
                                            <p class="text-muted small mb-3">
                                                Permanently remove your account and all associated data. This action cannot be undone.
                                            </p>
                                            <div class="alert alert-danger small mb-3">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Warning:</strong> This will delete all your data, usage history, and settings permanently.
                                            </div>
                                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteAccount()">
                                                <i class="fas fa-trash me-1"></i>Delete Account
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040; background: rgba(0,0,0,0.2);">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border: none;">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openSettingsModal() {
            var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
            settingsModal.show();
            loadUserSettings();
            loadLoginHistory();
            loadActiveSessions();
        }

        function loadUserSettings() {
            // Load current user settings into form
            {% if current_user.is_authenticated %}
            document.getElementById('theme').value = '{{ current_user.theme_preference or "dark" }}';
            document.getElementById('language').value = '{{ current_user.language_preference or "en" }}';
            document.getElementById('timezone').value = '{{ current_user.timezone_preference or "UTC" }}';
            document.getElementById('compactMode').checked = {{ 'true' if current_user.compact_mode else 'false' }};
            document.getElementById('animations').checked = {{ 'true' if current_user.animations_enabled else 'false' }};
            {% endif %}
        }

        function saveSettings() {
            const settings = {
                theme: document.getElementById('theme').value,
                language: document.getElementById('language').value,
                timezone: document.getElementById('timezone').value,
                compactMode: document.getElementById('compactMode').checked,
                animations: document.getElementById('animations').checked,
                emailNotifications: document.getElementById('emailNotifications').checked,
                browserNotifications: document.getElementById('browserNotifications').checked,
                marketingEmails: document.getElementById('marketingEmails').checked
            };

            fetch('/save-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Settings saved successfully!', 'success');
                    // Optionally close modal
                    bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
                } else {
                    showToast('Error saving settings: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showToast('Error saving settings', 'error');
            });
        }

        function loadLoginHistory() {
            fetch('/get-login-history')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('loginHistory');
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-muted small">No login history available</div>';
                    return;
                }

                let html = '<div class="list-group list-group-flush">';
                data.slice(0, 5).forEach(record => {
                    const successClass = record.is_successful ? 'text-success' : 'text-danger';
                    const icon = record.is_successful ? 'check-circle' : 'times-circle';
                    html += `
                        <div class="list-group-item bg-transparent border-secondary px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-${icon} ${successClass} me-2"></i>
                                    <small class="text-light">${record.login_time}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${record.ip_address}</small><br>
                                    <small class="text-muted">${record.location}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            })
            .catch(error => {
                document.getElementById('loginHistory').innerHTML = '<div class="text-danger small">Error loading login history</div>';
            });
        }

        function loadActiveSessions() {
            fetch('/get-active-sessions')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('activeSessions');
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-muted small">No active sessions</div>';
                    return;
                }

                let html = '<div class="list-group list-group-flush">';
                data.forEach(session => {
                    const currentBadge = session.is_current ? '<span class="badge bg-success ms-2">Current</span>' : '';
                    html += `
                        <div class="list-group-item bg-transparent border-secondary px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold text-light">${session.device_info}${currentBadge}</div>
                                    <small class="text-muted">${session.ip_address} • Last active: ${session.last_activity}</small>
                                </div>
                                ${!session.is_current ? `<button class="btn btn-outline-danger btn-sm" onclick="revokeSession(${session.id})">
                                    <i class="fas fa-times"></i>
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            })
            .catch(error => {
                document.getElementById('activeSessions').innerHTML = '<div class="text-danger small">Error loading sessions</div>';
            });
        }

        function revokeSession(sessionId) {
            if (confirm('Are you sure you want to revoke this session?')) {
                fetch(`/revoke-session/${sessionId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Session revoked successfully', 'success');
                        loadActiveSessions(); // Reload sessions
                    } else {
                        showToast('Error revoking session', 'error');
                    }
                })
                .catch(error => {
                    showToast('Error revoking session', 'error');
                });
            }
        }

        function confirmDeleteAccount() {
            if (confirm('Are you absolutely sure you want to delete your account? This action cannot be undone and will permanently delete all your data.')) {
                if (confirm('Please confirm once more: This will permanently delete your account and all associated data. Type "DELETE" to confirm this irreversible action.')) {
                    // Implement account deletion
                    showToast('Account deletion feature will be implemented', 'info');
                }
            }
        }

        // Update Save button to call our function
        document.addEventListener('DOMContentLoaded', function() {
            const saveButton = document.querySelector('.modal-footer .btn-primary');
            if (saveButton) {
                saveButton.addEventListener('click', saveSettings);
            }
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
